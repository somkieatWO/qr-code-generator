<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Code Generator API Docs</title>
  <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css" />
  <style>
    body { margin:0; background:#fafafa; }
    .topbar{display:none}
    .notice { padding: 10px 16px; background: #fff3cd; color: #856404; border-bottom: 1px solid #ffeeba; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .notice code { background: #fff; padding: 1px 4px; border: 1px solid #ffe8a1; border-radius: 3px; }
  </style>
</head>
<body>
  <div id="notice" class="notice" style="display:none"></div>
  <div id="swagger-ui"></div>
  <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js" crossorigin></script>
  <script>
    window.onload = async () => {
      const params = new URLSearchParams(window.location.search);
      const userSpec = params.get('spec');
      const overrideHost = params.get('host'); // e.g., api.example.com:443 or localhost:8080
      const overrideSchemes = params.get('schemes'); // e.g., https or http,https
      const overrideBasePath = params.get('basePath'); // e.g., /

      const isGithubPages = /\.github\.io$/i.test(window.location.hostname);

      // If on GitHub Pages, show a friendly warning about POST restrictions
      if (isGithubPages && !overrideHost) {
        const n = document.getElementById('notice');
        n.style.display = 'block';
        n.innerHTML = "GitHub Pages is a static host and blocks non-GET requests (like POST). 'Try it out' will fail here with 405. To test against a real server, pass query params like <code>?host=localhost:8080&schemes=http</code> and run the API locally, or deploy your API elsewhere.";
      }

      // Default to local docs/swagger.json (the spec is hosted alongside this page)
      // Add cache-busting to avoid GitHub Pages serving stale content
      const defaultSpec = './swagger.json?v=' + Date.now();
      const specUrl = userSpec || defaultSpec;

      // Common Swagger UI options with an interceptor to block POSTs to github.io itself
      const commonOptions = {
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [SwaggerUIBundle.presets.apis],
        layout: 'BaseLayout',
        requestInterceptor: (req) => {
          try {
            const method = (req.method || 'GET').toUpperCase();
            const target = new URL(req.url, window.location.href);
            const sameOrigin = target.origin === window.location.origin;
            if (isGithubPages && sameOrigin && method !== 'GET') {
              throw new Error('Blocked: GitHub Pages does not allow ' + method + ' to this host. Use ?host=your-api.example&schemes=https (or localhost:8080 with http).');
            }
          } catch (e) {
            // If URL parsing fails, let it through; the request will likely fail and show in UI
          }
          return req;
        }
      };

      // If any override is provided, fetch the spec JSON, mutate, and pass as object.
      try {
        if (overrideHost || overrideSchemes || overrideBasePath) {
          const resp = await fetch(specUrl, { cache: 'no-store' });
          const specObj = await resp.json();

          if (overrideHost) {
            // Remove protocol if user included it
            specObj.host = overrideHost.replace(/^https?:\/\//i, '');
          }
          if (overrideSchemes) {
            specObj.schemes = overrideSchemes.split(',').map(s => s.trim()).filter(Boolean);
          }
          if (overrideBasePath) {
            specObj.basePath = overrideBasePath;
          }

          const ui = SwaggerUIBundle(Object.assign({ spec: specObj }, commonOptions));
          window.ui = ui;
          return;
        }
      } catch (e) {
        console.error('Failed to apply spec overrides:', e);
        // Fallback to auto basePath or URL-based init below
      }

      // Auto-adjust basePath when hosted under a GitHub Pages project path (e.g., /qr-code-generator/)
      try {
        if (!overrideHost && !overrideSchemes && !overrideBasePath) {
          const pathParts = window.location.pathname.split('/').filter(Boolean);
          // Expect first segment to be the project name when using project Pages
          const first = pathParts[0];
          const desiredBasePath = first ? ('/' + first) : '/';
          // Only attempt if desired base path is not root and not just 'docs'
          if (desiredBasePath !== '/' && first !== 'docs') {
            const resp = await fetch(specUrl, { cache: 'no-store' });
            const specObj = await resp.json();
            if (!specObj.basePath || specObj.basePath === '/') {
              specObj.basePath = desiredBasePath;
            }
            const ui = SwaggerUIBundle(Object.assign({ spec: specObj }, commonOptions));
            window.ui = ui;
            return;
          }
        }
      } catch (e) {
        console.error('Failed to apply auto basePath:', e);
        // Fallback to URL-based init below
      }

      // Default initialization: load by URL without overrides
      const ui = SwaggerUIBundle(Object.assign({ url: specUrl }, commonOptions));
      window.ui = ui;
    };
  </script>
</body>
</html>

